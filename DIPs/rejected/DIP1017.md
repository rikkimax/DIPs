# Add Bottom Type

| Field           | Value                                                           |
|-----------------|-----------------------------------------------------------------|
| DIP:            | 1017                                                            |
| Review Count:   | 2                                                               |
| Author:         | Walter Bright                                                   |
| Implementation: |                                                                 |
| Status:         | Rejected                                                        |

## Abstract

Introduce a bottom type which is a type that has no values.

The primary purpose is to specify the return type of a function that does not return.

## Reference

[Bottom type](https://en.wikipedia.org/wiki/Bottom_type)

## Terminology

For the purpose of this document, the bottom type is referred to as *Tbottom*, a.k.a &perp;.

## Contents
* [Rationale](#rationale)
* [Description](#description)
* [Breaking Changes and Deprecations](#breaking-changes-and-deprecations)
* [Copyright & License](#copyright--license)
* [Reviews](#reviews)

## Rationale

Being able to specify that a function does not return has advantages:

1. Smaller/faster code - no stack cleanup code has to be emitted after such calls, no registers used on that branch need to be preserved, variables not used on that branch will not be marked as 'live', variables reassigned on that branch will not affect other branches.
2. Makes it easier to reason about the code by simplifying control flow.
3. It's necessary to be competitive with other systems programming languages.
4. RAII cleanup, `scope`, `finally`, and `catch` clauses need not be generated for such branches.

## Description

Since `assert(0)` is defined to never return, it is used to generate a bottom type:

```d
alias Tbottom = typeof(assert(0));
```

and is used like:

```d
Tbottom fatalError(string message) { ... }
```

Properties of `Tbottom`:

```d
Tbottom.mangleof == "??";
Tbottom.sizeof == 0;
Tbottom.alignsize == 1;
```

Type construction:

```d
Tbottom -> Tbottom
const(Tbottom) -> Tbottom
immutable(Tbottom) -> Tbottom
shared(Tbottom) -> Tbottom
inout(Tbottom) -> Tbottom
Tbottom* -> Tbottom
Tbottom[] -> Tbottom
Tbottom[integer] -> Tbottom
T[Tbottom] -> Tbottom
Tbottom[T] -> Tbottom
(Tbottom) -> (Tbottom)
```

A `Tbottom` is implicitly convertible to any other type. No other type is implicitly convertible to `Tbottom`.

### Declarations

A variable, parameter, field or enum may not be declared as `Tbottom`.

A function that returns `auto` may infer the return type as `Tbottom`.

### Expressions

```d
assert(0)
```
has type `Tbottom`.

```d
a || b
a && b
```
`b` may be of type `Tbottom`

```d
a ? b : c
```

1. If `b` and `c` are of type `Tbottom`, the result type is `Tbottom`.
2. Else if `b` is `Tbottom`, then the result is `typeof(c)`.
3. Else if `c` is `Tbottom`, then the result is `typeof(b)`.

```d
cast(Tbottom)expression
```
is an error if `expression` is not of type `Tbottom`.

```d
cast(T)expression
```
is allowed if `expression` is of type `Tbottom`.

Any attempt to use the value of a `Tbottom` expression is an error.

### Conversion

An expression of type `Tbottom` can be implicitly converted to any other type.

A function that returns a `Tbottom` is covariant with a function that returns any type `T` if `T` is returned via the registers or if the function returning `Tbottom` is overriding a function returning `T`.

It is implementation defined if a type `T` is returned via the registers.

### Existing Practice

The compiler explicitly marks a handful of functions known to never return:

```d
_d_throw@4
_d_throwc
_d_throwdwarf
_d_assert
_d_assertp
_d_assert_msg
_d_arraybounds
_d_arrayboundsp
_d_switch_error
_Unwind_Resume
_assert
__assert
__assert_rtn
```
Calls to these functions are internally generated by the compiler to support various semantics. The list is not user extensible, is implementation-defined, and is not visible to the user.

The compiler also recognizes `throw` statements and `assert(0)` expressions as never returning. A function that only has leaves that end with a `throw` statement, `assert(0)`, or a function call that is already marked as not returning is marked as not returning.

However, this relies on the compiler doing semantic analysis of the function body in advance, which does not happen for declarations nor for functions upon which attribute inference is not done.

Consider the C Standard function [`exit()`](https://www.tutorialspoint.com/c_standard_library/c_function_exit.htm). It does not return, but as the source is not available to the D compiler it is not marked as such. Thus, to indicate to the compiler that it is no return, one must write:

```d
exit(status); assert(0);
```

putting the burden on the caller of the function, rather than the function declaration. It's rarely seen in practice.

### Alternative

Use an attribute such as `@noreturn`. C++ uses this approach. This has the awkward result of a function specifying it has a return type `T`, but never returns that type. Other potential uses of a bottom type will not be expressible. An alias cannot be made from an attribute, and templates cannot accept attributes as arguments.

The advantage to `@noreturn` is a function that does not return can be made covariant with a function that returns a value via a hidden pointer.

## Breaking Changes and Deprecations

Currently, the return type of a function declared with an `auto` return type is inferred to be `void` when no value is returned. With this proposal, such functions may be inferred to return `Tbottom`.

## Copyright & License

Copyright (c) 2018 by the D Language Foundation

Licensed under Creative Commons Zero 1.0

## Reviews

### Community Review Round 1
[Reviewed Version](https://github.com/dlang/DIPs/blob/8274b0f600075e4553b41c31f4b77be2d917bb40/DIPs/DIP1017.md)

[Discussion](https://forum.dlang.org/post/bvyzkatgwlkiserqrcwk@forum.dlang.org)

A common criticism that arose in the Draft Review and was repeated in this review was that the proposed feature would be better implemented as an attribute or pragma rather than as an aliased type.

A suggestion was made that the proposal could be expanded to describe interactions with other language features and the implications thereof.

Alternative names for the type alias were proposed, including: `Bottom`, `bottom_t`, `never_t`, `never`, `nothing`.

A point was raised that `Tbottom* == typeof(null)` and `Tbottom[] == typeof([])` would be preferable to both cases equating to `Tbottom`.

The concern was raised that the feature would complicate the language implementation.

### Final Review
[Reviewed Version](https://github.com/dlang/DIPs/blob/4716033a8cbc2ee024bfad8942b2ff6b63521f63/DIPs/DIP1017.md)

[Discussion](https://forum.dlang.org/post/qnrkfiqmtqzpyocxxtsk@forum.dlang.org)

This review round generated a tremendous amount of feedback and debate. The most common criticism was that the DIP had not been revised to address any of the criticisms from the Community Review round and, as such, it should not have been allowed to proceed to the Final Review. Debate touched on many issues, including whether `void` can be used as a bottom type, how conversions would be andled, the behavior of non-returning functions, type theory, and much more that interested readers may peruse by following the Discussion link above. Following are highlights of the criticisms that surfaced. 

As in the Community Review, there was resistance to the name `Tbottom` and alternative names were proposed. The DIP Author countered, saying that the "Bottom" type is present in existing books on type theory, while alternatives like "Never" are not. The DIP Author also said that "bottom type" is a suitable term for search engines, with [a Wikipedia article](https://en.wikipedia.org/wiki/Bottom_type) on the concept showing up in the search results. 

One reviewer said the DIP need not choose a name since it introduces a new type and not a keyword; users are free to alias the result of `typeof(Tbottom)` to use any name they choose. The DIP Author agreed, saying that avoiding the introduction of a new keyword was a motivation.

More than one reviewer pointed out that this DIP introduces two concepts: a bottom type, and the ability to mark non-returning functions. They said the DIP is written to justify the use of `Tbottom` to mark non-returning functions but otherwise fails to justify the introduction of a new type for such a purpose. Among such cricisms was that the existing justification is incomplete.

More than one reviewer complained that there was no rationale provided for why a new type should be preferred to an attribute or a pragma for marking non-returning functions, a repeated criticism from the Community Review, with many saying a new type should not be introduced. The DIP Author conceded that whether a new type is warranted is a good question, and noted that neither he nor the majority of the community have a solid understanding of formal type theory, leaving the issue open to further debate.

One reviewer suggested using a syntax such as `__traits(wontReturn, ...)` to mark a function which does not return.

One reviewer suggested that if a bottom type is introduced, then the related concepts of a top type and a unit type should be supported as well.

More than one reviewer found the DIP difficult to understand and suggested all DIPs should be required to use simple language.

More than one reviewer found dubious the rationale "It's necessary to be competitive with other systems programming languages" as a reason for adding a type to mark non-returning functions. One reviewer noted that, despite including this point, the DIP does not analyze the approaches taken by other languages for comparisons.

### Formal Assessment
There was no Formal Assessment period for this DIP. Given that the DIP Author is also one of the Language Maintainters, he decided the appropriate course of action in light of the feedback in both review rounds is to mark this DIP as rejected. He still thinks there is value in adding a bottom type to the language, but has decided to revisit the issue at a later date.